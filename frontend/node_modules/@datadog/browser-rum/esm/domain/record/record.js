import { sendToExtension } from '@datadog/browser-core';
import * as replayStats from '../replayStats';
import { trackFocus, trackFrustration, trackInput, trackMediaInteraction, trackMouseInteraction, trackMove, trackMutation, trackScroll, trackStyleSheet, trackViewEnd, trackViewportResize, trackVisualViewportResize, } from './trackers';
import { createElementsScrollPositions } from './elementsScrollPositions';
import { initShadowRootsController } from './shadowRootsController';
import { startFullSnapshots } from './startFullSnapshots';
import { createRecordingScope } from './recordingScope';
export function record(options) {
    const { emitRecord, emitStats, configuration, lifeCycle } = options;
    // runtime checks for user options
    if (!emitRecord || !emitStats) {
        throw new Error('emit functions are required');
    }
    const processRecord = (record) => {
        emitRecord(record);
        sendToExtension('record', { record });
        const view = options.viewHistory.findView();
        replayStats.addRecord(view.id);
    };
    const shadowRootsController = initShadowRootsController(processRecord, emitStats);
    const scope = createRecordingScope(configuration, createElementsScrollPositions(), shadowRootsController);
    const { stop: stopFullSnapshots } = startFullSnapshots(lifeCycle, processRecord, emitStats, flushMutations, scope);
    function flushMutations() {
        shadowRootsController.flush();
        mutationTracker.flush();
    }
    const mutationTracker = trackMutation(document, processRecord, emitStats, scope);
    const trackers = [
        mutationTracker,
        trackMove(processRecord, scope),
        trackMouseInteraction(processRecord, scope),
        trackScroll(document, processRecord, scope),
        trackViewportResize(processRecord, scope),
        trackInput(document, processRecord, scope),
        trackMediaInteraction(processRecord, scope),
        trackStyleSheet(processRecord, scope),
        trackFocus(processRecord, scope),
        trackVisualViewportResize(processRecord, scope),
        trackFrustration(lifeCycle, processRecord, scope),
        trackViewEnd(lifeCycle, processRecord, flushMutations),
    ];
    return {
        stop: () => {
            shadowRootsController.stop();
            trackers.forEach((tracker) => tracker.stop());
            stopFullSnapshots();
        },
        flushMutations,
        shadowRootsController,
    };
}
//# sourceMappingURL=record.js.map