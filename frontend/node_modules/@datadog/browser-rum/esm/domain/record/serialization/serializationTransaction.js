import { elapsed, timeStampNow } from '@datadog/browser-core';
import { createSerializationStats, updateSerializationStats } from './serializationStats';
/**
 * Perform serialization within a transaction. At the end of the transaction, the
 * generated records and statistics will be emitted.
 */
export function serializeInTransaction(kind, emitRecord, emitStats, scope, serialize) {
    const records = [];
    const stats = createSerializationStats();
    const transaction = {
        add(record) {
            records.push(record);
        },
        addMetric(metric, value) {
            updateSerializationStats(stats, metric, value);
        },
        assignId(node) {
            const id = scope.nodeIds.getOrInsert(node);
            if (transaction.serializedNodeIds) {
                transaction.serializedNodeIds.add(id);
            }
            return id;
        },
        kind,
        scope,
    };
    const start = timeStampNow();
    serialize(transaction);
    updateSerializationStats(stats, 'serializationDuration', elapsed(start, timeStampNow()));
    for (const record of records) {
        emitRecord(record);
    }
    emitStats(stats);
}
//# sourceMappingURL=serializationTransaction.js.map