(self.webpackChunk_datadog_browser_rum=self.webpackChunk_datadog_browser_rum||[]).push([["profiler"],{437(e,t,n){n.d(t,{createRumProfiler:()=>f});var s=n(315),a=n(197),r=n(433),i=n(875),o=n(749),c=n(636),u=n(951);const l=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g,d=(e,t)=>e||function(e){return e?e.replace(l,"/?"):"/"}(t);var p=n(485);const m={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function f(e,t,n,l,f,v,w,g=m){const h=(0,u.wP)(e,t,v,6);let k;const b=[];let y={state:"stopped",stateReason:"initializing"};function I(){if("running"===y.state)return;const t=w.findView();k=t?{startClocks:t.startClocks,viewId:t.id,viewName:d(t.name,document.location.pathname)}:void 0,b.push((0,a.q)(e,window,"visibilitychange",P).stop,(0,a.q)(e,window,"beforeunload",x).stop),_()}async function S(e){await async function(e){"running"===y.state&&(await D(),y={state:"stopped",stateReason:e})}(e),b.forEach(e=>e()),l.set({status:"stopped",error_reason:void 0})}function _(){const e=(0,r.VZ)().Profiler;if(!e)throw l.set({status:"error",error_reason:"not-supported-by-browser"}),Error("RUM Profiler is not supported in this browser.");M(y).catch(s.Dx);const{cleanupTasks:n}=function(e){if("running"===e.state)return{cleanupTasks:e.cleanupTasks};const n=[],s=t.subscribe(2,e=>{const t={viewId:e.id,viewName:d(e.name,document.location.pathname),startClocks:e.startClocks};T(t),k=t});return n.push(s.unsubscribe),{cleanupTasks:n}}(y);let a;try{a=new e({sampleInterval:g.sampleIntervalMs,maxBufferSize:Math.round(1.5*g.collectIntervalMs/g.sampleIntervalMs)})}catch(e){return void(e instanceof Error&&e.message.includes("disabled by Document Policy")?(i.Vy.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",e),l.set({status:"error",error_reason:"missing-document-policy-header"})):l.set({status:"error",error_reason:"unexpected-exception"}))}l.set({status:"running",error_reason:void 0}),y={state:"running",startClocks:(0,o.M8)(),profiler:a,timeoutId:(0,c.wg)(_,g.collectIntervalMs),views:[],cleanupTasks:n,longTasks:[]},T(k),a.addEventListener("samplebufferfull",C)}async function M(t){if("running"!==t.state)return;(0,c.DJ)(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",C);const{startClocks:a,views:r}=t;await t.profiler.stop().then(t=>{const s=(0,o.M8)(),i=(0,o.vk)(a.timeStamp,s.timeStamp),c=f.findLongTasks(a.relative,i),u=i<g.minProfileDurationMs,l=function(e){let t=0;for(const n of e)void 0!==n.stackId&&t++;return t}(t.samples)<g.minNumberOfSamples;0===c.length&&(u||l)||function(t){var s;const a=null===(s=n.findTrackedSession())||void 0===s?void 0:s.id,r=function(e,t,n){const s=function(e,t,n){const s=(0,p.m5)(t),a=function(e,t,n){const s={application:{id:t}};n&&(s.session={id:n});const{ids:a,names:r}=function(e){const t={ids:[],names:[]};for(const n of e)t.ids.push(n.viewId),n.viewName&&t.names.push(n.viewName);return t.names=Array.from(new Set(t.names)),t}(e.views);a.length&&(s.view={id:a,name:r});const i=e.longTasks.map(e=>e.id).filter(e=>void 0!==e);return i.length&&(s.long_task={id:i}),s}(e,t.applicationId,n),r=function(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}(s);return{...a,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:r.join(","),_dd:{clock_drift:(0,o.TP)()}}}(e,t,n);return{event:s,"wall-time.json":e}}(t,e,a);h.send(r)}(Object.assign(t,{startClocks:a,endClocks:s,clocksOrigin:(0,o.Oc)(),longTasks:c,views:r,sampleInterval:g.sampleIntervalMs}))}).catch(s.Dx)}async function D(){"running"===y.state&&(y.cleanupTasks.forEach(e=>e()),await M(y))}function T(e){"running"===y.state&&e&&y.views.push(e)}function C(){_()}function P(){"hidden"===document.visibilityState&&"running"===y.state?async function(){"running"===y.state&&(await D(),y={state:"paused"})}().catch(s.Dx):"visible"===document.visibilityState&&"paused"===y.state&&_()}function x(){_()}return t.subscribe(9,()=>{S("session-expired").catch(s.Dx)}),t.subscribe(10,()=>{"stopped"===y.state&&"session-expired"===y.stateReason&&I()}),{start:I,async stop(){await S("stopped-by-user")},isStopped:()=>"stopped"===y.state,isRunning:()=>"running"===y.state,isPaused:()=>"paused"===y.state}}}}]);