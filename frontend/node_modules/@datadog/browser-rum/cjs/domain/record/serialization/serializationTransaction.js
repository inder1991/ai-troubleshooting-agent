"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeInTransaction = serializeInTransaction;
const browser_core_1 = require("@datadog/browser-core");
const serializationStats_1 = require("./serializationStats");
/**
 * Perform serialization within a transaction. At the end of the transaction, the
 * generated records and statistics will be emitted.
 */
function serializeInTransaction(kind, emitRecord, emitStats, scope, serialize) {
    const records = [];
    const stats = (0, serializationStats_1.createSerializationStats)();
    const transaction = {
        add(record) {
            records.push(record);
        },
        addMetric(metric, value) {
            (0, serializationStats_1.updateSerializationStats)(stats, metric, value);
        },
        assignId(node) {
            const id = scope.nodeIds.getOrInsert(node);
            if (transaction.serializedNodeIds) {
                transaction.serializedNodeIds.add(id);
            }
            return id;
        },
        kind,
        scope,
    };
    const start = (0, browser_core_1.timeStampNow)();
    serialize(transaction);
    (0, serializationStats_1.updateSerializationStats)(stats, 'serializationDuration', (0, browser_core_1.elapsed)(start, (0, browser_core_1.timeStampNow)()));
    for (const record of records) {
        emitRecord(record);
    }
    emitStats(stats);
}
//# sourceMappingURL=serializationTransaction.js.map