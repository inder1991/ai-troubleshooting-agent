"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.startFullSnapshots = startFullSnapshots;
exports.takeFullSnapshot = takeFullSnapshot;
const browser_rum_core_1 = require("@datadog/browser-rum-core");
const browser_core_1 = require("@datadog/browser-core");
const types_1 = require("../../types");
const serialization_1 = require("./serialization");
const viewports_1 = require("./viewports");
function startFullSnapshots(lifeCycle, emitRecord, emitStats, flushMutations, scope) {
    takeFullSnapshot((0, browser_core_1.timeStampNow)(), 0 /* SerializationKind.INITIAL_FULL_SNAPSHOT */, emitRecord, emitStats, scope);
    const { unsubscribe } = lifeCycle.subscribe(2 /* LifeCycleEventType.VIEW_CREATED */, (view) => {
        flushMutations();
        takeFullSnapshot(view.startClocks.timeStamp, 1 /* SerializationKind.SUBSEQUENT_FULL_SNAPSHOT */, emitRecord, emitStats, scope);
    });
    return {
        stop: unsubscribe,
    };
}
function takeFullSnapshot(timestamp, kind, emitRecord, emitStats, scope) {
    (0, serialization_1.serializeInTransaction)(kind, emitRecord, emitStats, scope, (transaction) => {
        const { width, height } = (0, browser_rum_core_1.getViewportDimension)();
        transaction.add({
            data: {
                height,
                href: window.location.href,
                width,
            },
            type: types_1.RecordType.Meta,
            timestamp,
        });
        transaction.add({
            data: {
                has_focus: document.hasFocus(),
            },
            type: types_1.RecordType.Focus,
            timestamp,
        });
        transaction.add({
            data: {
                node: (0, serialization_1.serializeDocument)(document, transaction),
                initialOffset: {
                    left: (0, browser_rum_core_1.getScrollX)(),
                    top: (0, browser_rum_core_1.getScrollY)(),
                },
            },
            type: types_1.RecordType.FullSnapshot,
            timestamp,
        });
        if (window.visualViewport) {
            transaction.add({
                data: (0, viewports_1.getVisualViewport)(window.visualViewport),
                type: types_1.RecordType.VisualViewport,
                timestamp,
            });
        }
    });
}
//# sourceMappingURL=startFullSnapshots.js.map